#!/bin/sh

# Enable the device
ip link set wlan0 up

# Main route
route add -net 192.168.12.0 netmask 255.255.255.0 gw 192.168.12.1 dev wlan0

# Wait for modem to ready
sleep 5

# Check if modem plugged
command=`lsusb | grep "201e:10f8"`
if [ "$command" == "" ]; then
  # Start wifi only
  create_ap --driver rtl871xdrv --no-virt -n wlan0 bikinibottom 1223334444
else
  # Remove if usbserial module already loaded before
  command=`lsmod | grep usbserial`
  if [ "$command" != "" ]; then
    rmmod usbserial
  fi

  # Wait for another seconds
  sleep 5

  # Load module
  modprobe usbserial vendor=0x201e product=0x10f8

  # Keep dials if not connected
  (
     while : ; do
         wvdial
         sleep 10
     done
  ) &

  # Some routing
  route add -net 0.0.0.0 dev ppp0

  # Fire up the wifi
  create_ap --driver rtl871xdrv --no-virt wlan0 ppp0 bikinibottom 1223334444
fi
